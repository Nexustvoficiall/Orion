<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#0a0118">
  <title>Renovar Plano - Orion Creator</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --purple1: #3b0066;
      --purple2: #5b21b6;
      --accent: #a855f7;
      --gold: #fbbf24;
      --success: #22c55e;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Poppins', system-ui, sans-serif;
      background: radial-gradient(ellipse at top, #0a0118 0%, #12002a 40%, #1a0340 100%);
      color: #eae6ff;
      min-height: 100vh;
      overflow-x: hidden;
    }

    .stars {
      position: fixed;
      inset: 0;
      background: url("https://www.transparenttextures.com/patterns/stardust.png");
      opacity: 0.3;
      z-index: -1;
      animation: moveStars 180s linear infinite;
    }

    @keyframes moveStars {
      from { background-position: 0 0; }
      to { background-position: -10000px 5000px; }
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 20px;
    }

    /* Header */
    .header {
      text-align: center;
      margin-bottom: 50px;
    }

    .logo {
      font-family: 'Orbitron', sans-serif;
      font-size: 2.5rem;
      font-weight: 900;
      background: linear-gradient(135deg, #c084fc, #a855f7, #9333ea);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      color: transparent;
      text-shadow: 0 0 40px rgba(168, 85, 247, 0.4);
      margin-bottom: 20px;
    }

    .warning-badge {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.1));
      border: 2px solid rgba(239, 68, 68, 0.4);
      padding: 15px 30px;
      border-radius: 100px;
      font-size: 1.1rem;
      font-weight: 600;
      color: #fca5a5;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 20px rgba(239, 68, 68, 0.3); }
      50% { box-shadow: 0 0 40px rgba(239, 68, 68, 0.5); }
    }

    .subtitle {
      font-size: 1.1rem;
      color: rgba(255, 255, 255, 0.7);
      margin-top: 20px;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }

    /* Plans Grid */
    .plans-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 25px;
      margin-bottom: 40px;
    }

    .plan-card {
      position: relative;
      background: rgba(255, 255, 255, 0.03);
      border: 2px solid rgba(168, 85, 247, 0.15);
      border-radius: 24px;
      padding: 35px 25px;
      text-align: center;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      overflow: hidden;
    }

    .plan-card::before {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top, rgba(168, 85, 247, 0.1), transparent 70%);
      opacity: 0;
      transition: opacity 0.4s ease;
    }

    .plan-card:hover {
      transform: translateY(-10px);
      border-color: var(--accent);
      box-shadow: 0 20px 50px rgba(168, 85, 247, 0.3);
    }

    .plan-card:hover::before {
      opacity: 1;
    }

    /* Popular Badge */
    .plan-card.popular {
      border-color: var(--gold);
      transform: scale(1.03);
    }

    .plan-card.popular:hover {
      transform: scale(1.03) translateY(-10px);
      box-shadow: 0 20px 50px rgba(251, 191, 36, 0.3);
    }

    .popular-badge {
      position: absolute;
      top: -1px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, var(--gold), #f59e0b);
      color: #1a0b2e;
      padding: 8px 25px;
      border-radius: 0 0 15px 15px;
      font-weight: 800;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .plan-icon {
      font-size: 3rem;
      margin-bottom: 15px;
    }

    .plan-name {
      font-family: 'Orbitron', sans-serif;
      font-size: 1.4rem;
      font-weight: 700;
      color: #c084fc;
      margin-bottom: 8px;
    }

    .plan-card.popular .plan-name {
      color: var(--gold);
    }

    .plan-duration {
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.5);
      margin-bottom: 20px;
    }

    .plan-price {
      margin-bottom: 20px;
    }

    .price-value {
      font-family: 'Orbitron', sans-serif;
      font-size: 2.8rem;
      font-weight: 900;
      color: white;
    }

    .price-currency {
      font-size: 1.2rem;
      color: rgba(255, 255, 255, 0.6);
      vertical-align: super;
    }

    .price-period {
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.4);
    }

    .plan-savings {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(22, 163, 74, 0.1));
      border: 1px solid rgba(34, 197, 94, 0.3);
      color: #86efac;
      padding: 8px 15px;
      border-radius: 50px;
      font-size: 0.8rem;
      font-weight: 600;
      margin-bottom: 20px;
      display: inline-block;
    }

    .plan-features {
      list-style: none;
      margin-bottom: 25px;
      text-align: left;
    }

    .plan-features li {
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.7);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .plan-features li:last-child {
      border-bottom: none;
    }

    .plan-features li::before {
      content: '‚úì';
      color: var(--success);
      font-weight: 700;
    }

    .plan-btn {
      width: 100%;
      padding: 16px 24px;
      background: linear-gradient(135deg, var(--purple2), var(--accent));
      border: none;
      border-radius: 14px;
      color: white;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      z-index: 10;
      pointer-events: auto;
      position: relative;
    }

    .plan-btn:hover {
      transform: scale(1.02);
      box-shadow: 0 10px 30px rgba(168, 85, 247, 0.4);
    }

    .plan-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .plan-card.popular .plan-btn {
      background: linear-gradient(135deg, var(--gold), #f59e0b);
      color: #1a0b2e;
    }

    /* PIX Section */
    .pix-info {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(34, 197, 94, 0.2);
      border-radius: 16px;
      padding: 25px;
      text-align: center;
      margin-bottom: 30px;
    }

    .pix-info h3 {
      color: #86efac;
      font-size: 1.1rem;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .pix-info p {
      color: rgba(255, 255, 255, 0.6);
      font-size: 0.9rem;
    }

    /* Footer */
    .footer {
      text-align: center;
      padding-top: 30px;
      border-top: 1px solid rgba(168, 85, 247, 0.1);
    }

    .btn-voltar {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: rgba(255, 255, 255, 0.6);
      padding: 12px 30px;
      border-radius: 10px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-voltar:hover {
      border-color: var(--accent);
      color: white;
      background: rgba(168, 85, 247, 0.1);
    }

    .support-text {
      margin-top: 20px;
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.4);
    }

    .support-text a {
      color: var(--accent);
      text-decoration: none;
    }

    /* Modal PIX */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(10px);
      z-index: 10000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: linear-gradient(135deg, rgba(30, 11, 58, 0.98), rgba(46, 16, 101, 0.98));
      border: 2px solid rgba(34, 197, 94, 0.3);
      border-radius: 24px;
      padding: 40px;
      width: 100%;
      max-width: 450px;
      text-align: center;
      animation: modalIn 0.4s ease;
    }

    @keyframes modalIn {
      from { opacity: 0; transform: scale(0.9) translateY(20px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }

    .modal-close {
      position: absolute;
      top: 15px;
      right: 20px;
      background: none;
      border: none;
      color: rgba(255, 255, 255, 0.5);
      font-size: 2rem;
      cursor: pointer;
    }

    .modal h2 {
      font-family: 'Orbitron', sans-serif;
      color: #86efac;
      margin-bottom: 10px;
    }

    .modal-plan-name {
      color: var(--accent);
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .modal-plan-price {
      font-family: 'Orbitron', sans-serif;
      font-size: 2rem;
      font-weight: 900;
      color: white;
      margin-bottom: 25px;
    }

    .qr-container {
      background: white;
      padding: 20px;
      border-radius: 16px;
      display: inline-block;
      margin-bottom: 20px;
    }

    .qr-container img {
      max-width: 200px;
      height: auto;
    }

    .qr-container canvas {
      max-width: 200px !important;
      height: auto !important;
    }

    .pix-code-container {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(34, 197, 94, 0.3);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .pix-code {
      font-family: monospace;
      font-size: 0.75rem;
      color: #86efac;
      word-break: break-all;
      margin-bottom: 10px;
    }

    .btn-copiar {
      background: linear-gradient(135deg, #16a34a, #22c55e);
      border: none;
      color: white;
      padding: 12px 30px;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-copiar:hover {
      transform: scale(1.05);
      box-shadow: 0 5px 20px rgba(34, 197, 94, 0.4);
    }

    .timer {
      margin-top: 20px;
      color: rgba(255, 255, 255, 0.5);
      font-size: 0.9rem;
    }

    .timer span {
      color: var(--gold);
      font-weight: 700;
    }

    .status-msg {
      margin-top: 15px;
      padding: 12px 20px;
      border-radius: 10px;
      font-weight: 600;
    }

    .status-msg.aguardando {
      background: rgba(251, 191, 36, 0.1);
      border: 1px solid rgba(251, 191, 36, 0.3);
      color: #fbbf24;
    }

    .status-msg.sucesso {
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.3);
      color: #22c55e;
    }

    .status-msg.erro {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #ef4444;
    }

    /* Loading */
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(168, 85, 247, 0.2);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .logo { font-size: 1.8rem; }
      .plans-grid { grid-template-columns: 1fr; }
      .plan-card.popular { transform: none; }
      .plan-card.popular:hover { transform: translateY(-10px); }
      .price-value { font-size: 2.2rem; }
    }
  </style>
</head>
<body>
  <div class="stars"></div>

  <div class="container">
    <!-- Header -->
    <header class="header">
      <h1 class="logo">üåå ORION CREATOR</h1>
      <div class="warning-badge">
        <span>‚ö†Ô∏è</span>
        <span>Seu plano expirou</span>
      </div>
      <p class="subtitle">
        N√£o se preocupe! Renove agora e continue criando banners e v√≠deos promocionais incr√≠veis. 
        Pagamento instant√¢neo via <strong>PIX</strong>!
      </p>
    </header>

    <!-- PIX Info -->
    <div class="pix-info">
      <h3>
        <svg width="24" height="24" viewBox="0 0 512 512" fill="#86efac"><path d="M242.4 292.5C247.8 287.1 257.1 287.1 262.5 292.5L339.5 369.5C353.7 383.7 372.6 391.5 392.6 391.5H407.7L310.6 488.6C280.3 518.1 231.1 518.1 200.8 488.6L103.3 391.2H112.6C132.6 391.2 151.5 383.4 165.7 369.2L242.4 292.5zM262.5 218.9C257.1 224.4 247.9 224.4 242.4 218.9L165.7 142.2C151.5 128 132.6 120.2 112.6 120.2H103.3L200.4 23.08C230.7-7.297 279.9-7.297 310.2 23.08L407.3 120.2H392.2C372.2 120.2 353.3 128 339.1 142.2L262.5 218.9zM112.6 142.7C126.4 142.7 139.1 148.3 149.7 158.1L226.4 234.8C233.6 241.1 243 245.6 253.2 245.6C263.4 245.6 272.8 241.1 280 234.8L356.7 158.1C367.3 148.3 380 142.7 393.8 142.7H430.3L488.6 200.1C518.9 231.3 518.9 280.5 488.6 310.7L430.3 369H393.8C380 369 367.3 363.4 356.7 353.6L280 276.9C272.8 269.7 263.4 266.2 253.2 266.2C243 266.2 233.6 269.7 226.4 276.9L149.7 353.6C139.1 363.4 126.4 369 112.6 369H81.14L23.08 310.1C-7.297 280.8-7.297 231.6 23.08 201.3L81.14 142.7H112.6z"/></svg>
        Pagamento R√°pido via PIX
      </h3>
      <p>Aprova√ß√£o instant√¢nea ‚Ä¢ Sem taxas adicionais ‚Ä¢ 100% Seguro</p>
    </div>

    <!-- Plans -->
    <div class="plans-grid">
      <!-- Mensal -->
      <div class="plan-card" data-plan="mensal">
        <div class="plan-icon">üìÖ</div>
        <h3 class="plan-name">MENSAL</h3>
        <p class="plan-duration">30 dias de acesso</p>
        <div class="plan-price">
          <span class="price-currency">R$</span>
          <span class="price-value">35</span>
          <span class="price-period">/m√™s</span>
        </div>
        <ul class="plan-features">
          <li>Banners ilimitados</li>
          <li>V√≠deos promocionais</li>
          <li>Todos os modelos</li>
          <li>Suporte por WhatsApp</li>
        </ul>
        <button class="plan-btn" onclick="iniciarPagamento('mensal', 35.00, 30)">
          <span>Pagar com PIX</span>
          <span>üí≥</span>
        </button>
      </div>

      <!-- Trimestral -->
      <div class="plan-card" data-plan="trimestral">
        <div class="plan-icon">üìÜ</div>
        <h3 class="plan-name">TRIMESTRAL</h3>
        <p class="plan-duration">90 dias de acesso</p>
        <div class="plan-price">
          <span class="price-currency">R$</span>
          <span class="price-value">99<sup style="font-size: 1rem;">,90</sup></span>
          <span class="price-period">/3 meses</span>
        </div>
        <div class="plan-savings">üéâ Economia de R$ 5,10</div>
        <ul class="plan-features">
          <li>Banners ilimitados</li>
          <li>V√≠deos promocionais</li>
          <li>Todos os modelos</li>
          <li>Suporte priorit√°rio</li>
        </ul>
        <button class="plan-btn" onclick="iniciarPagamento('trimestral', 99.90, 90)">
          <span>Pagar com PIX</span>
          <span>üí≥</span>
        </button>
      </div>

      <!-- Semestral - POPULAR -->
      <div class="plan-card popular" data-plan="semestral">
        <div class="popular-badge">‚≠ê MAIS POPULAR</div>
        <div class="plan-icon">üóìÔ∏è</div>
        <h3 class="plan-name">SEMESTRAL</h3>
        <p class="plan-duration">180 dias de acesso</p>
        <div class="plan-price">
          <span class="price-currency">R$</span>
          <span class="price-value">169<sup style="font-size: 1rem;">,90</sup></span>
          <span class="price-period">/6 meses</span>
        </div>
        <div class="plan-savings">üî• Economia de R$ 40,10</div>
        <ul class="plan-features">
          <li>Banners ilimitados</li>
          <li>V√≠deos promocionais</li>
          <li>Todos os modelos</li>
          <li>Suporte VIP 24h</li>
          <li>Novos recursos primeiro</li>
        </ul>
        <button class="plan-btn" onclick="iniciarPagamento('semestral', 169.90, 180)">
          <span>Pagar com PIX</span>
          <span>üí≥</span>
        </button>
      </div>

      <!-- Anual -->
      <div class="plan-card" data-plan="anual">
        <div class="plan-icon">üìö</div>
        <h3 class="plan-name">ANUAL</h3>
        <p class="plan-duration">365 dias de acesso</p>
        <div class="plan-price">
          <span class="price-currency">R$</span>
          <span class="price-value">250</span>
          <span class="price-period">/ano</span>
        </div>
        <div class="plan-savings">üöÄ Economia de R$ 170,00</div>
        <ul class="plan-features">
          <li>Banners ilimitados</li>
          <li>V√≠deos promocionais</li>
          <li>Todos os modelos</li>
          <li>Suporte VIP 24h</li>
          <li>Novos recursos primeiro</li>
          <li>Badge exclusivo</li>
        </ul>
        <button class="plan-btn" onclick="iniciarPagamento('anual', 250.00, 365)">
          <span>Pagar com PIX</span>
          <span>üí≥</span>
        </button>
      </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
      <button class="btn-voltar" onclick="window.location.href='/index.html'">
        ‚Üê Voltar ao Login
      </button>
      <p class="support-text">
        Problemas com pagamento? <a href="https://wa.me/5511999999999" target="_blank">Fale conosco no WhatsApp</a>
      </p>
    </footer>
  </div>

  <!-- Modal PIX -->
  <div class="modal-overlay" id="modalPix">
    <div class="modal" style="position: relative;">
      <button class="modal-close" onclick="fecharModal()">&times;</button>
      
      <h2>üîê Pagamento PIX</h2>
      <p class="modal-plan-name" id="modalPlanName">Plano Mensal</p>
      <p class="modal-plan-price" id="modalPlanPrice">R$ 35,00</p>
      
      <div id="pixLoading">
        <div class="loading-spinner"></div>
        <p style="color: rgba(255,255,255,0.6);">Gerando QR Code...</p>
      </div>
      
      <div id="pixContent" style="display: none;">
        <div class="qr-container" id="qrContainer">
          <!-- QR Code ser√° inserido aqui -->
        </div>
        
        <div class="pix-code-container">
          <p style="font-size: 0.8rem; color: rgba(255,255,255,0.5); margin-bottom: 8px;">C√≥digo PIX Copia e Cola:</p>
          <p class="pix-code" id="pixCode">Carregando...</p>
          <button class="btn-copiar" onclick="copiarPix()">üìã Copiar C√≥digo</button>
        </div>
        
        <div class="timer">
          ‚è±Ô∏è Expira em: <span id="timerDisplay">15:00</span>
        </div>
        
        <div class="status-msg aguardando" id="statusMsg">
          ‚è≥ Aguardando pagamento...
        </div>
      </div>
      
      <div id="pixErro" style="display: none;">
        <div class="status-msg erro">
          ‚ùå Erro ao gerar PIX. Tente novamente.
        </div>
        <button class="plan-btn" style="margin-top: 20px;" onclick="fecharModal()">Tentar Novamente</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <noscript>
    <div style="background: #ef4444; color: white; text-align: center; padding: 16px; font-weight: bold;">‚ö†Ô∏è O JavaScript est√° desativado ou n√£o carregou. O pagamento n√£o funcionar√°.</div>
  </noscript>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getDatabase, ref, update } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
    import { getFirestore, doc, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyCJU2wA6lL4aglQIzPrlyYdl_5xaIZqIec",
      authDomain: "orion-lab-a9298.firebaseapp.com",
      databaseURL: "https://orion-lab-a9298-default-rtdb.firebaseio.com",
      projectId: "orion-lab-a9298",
      storageBucket: "orion-lab-a9298.firebasestorage.app",
      messagingSenderId: "421847499235",
      appId: "1:421847499235:web:5c271435a1c9d2fe58a0d6"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const rtdb = getDatabase(app);
    const firestore = getFirestore(app);

    let currentUser = null;
    let currentPaymentId = null;
    let timerInterval = null;
    let checkInterval = null;

    // Verificar usu√°rio logado
    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        console.log('‚úÖ Usu√°rio logado:', user.email);
      } else {
        console.log('‚ö†Ô∏è Usu√°rio n√£o logado - continuando sem autentica√ß√£o');
      }
    });

    // Iniciar Pagamento PIX - EXPOSTA GLOBALMENTE
    async function iniciarPagamento(plano, valor, dias) {
      console.log(`üí≥ Iniciando pagamento: ${plano} - R$ ${valor.toFixed(2)} (${dias} dias)`);
      
      // Abrir modal
      document.getElementById('modalPix').classList.add('active');
      document.getElementById('modalPlanName').textContent = `Plano ${plano.charAt(0).toUpperCase() + plano.slice(1)}`;
      document.getElementById('modalPlanPrice').textContent = `R$ ${valor.toFixed(2).replace('.', ',')}`;
      
      // Mostrar loading
      document.getElementById('pixLoading').style.display = 'block';
      document.getElementById('pixContent').style.display = 'none';
      document.getElementById('pixErro').style.display = 'none';
      
      try {
        // Preparar headers
        const headers = {
          'Content-Type': 'application/json'
        };
        
        // Adicionar token se usu√°rio logado
        if (currentUser) {
          try {
            const token = await currentUser.getIdToken();
            headers['Authorization'] = `Bearer ${token}`;
          } catch (e) {
            console.warn('N√£o foi poss√≠vel obter token:', e);
          }
        }
        
        // Chamar API para criar PIX
        const response = await fetch('/api/criar-pix', {
          method: 'POST',
          headers,
          body: JSON.stringify({
            plano,
            valor,
            dias,
            email: currentUser?.email || 'cliente@orioncreator.com',
            userId: currentUser?.uid || null
          })
        });
        
        const data = await response.json();
        console.log('üì¶ Resposta da API:', data);
        
        if (!response.ok || data.error) {
          throw new Error(data.error || data.details || 'Erro ao criar PIX');
        }
        
        console.log('‚úÖ PIX criado:', data);
        
        // Mostrar conte√∫do
        document.getElementById('pixLoading').style.display = 'none';
        document.getElementById('pixContent').style.display = 'block';
        
        // Salvar ID do pagamento
        currentPaymentId = data.paymentId;
        
        // Mostrar c√≥digo PIX (copia & cola)
        const pixCode = data.pixCode || data.qrCode || '';
        document.getElementById('pixCode').textContent = pixCode || '‚Äî';

        // Gerar/mostrar QR Code
        const qrContainer = document.getElementById('qrContainer');
        qrContainer.innerHTML = '';

        // Se API retornar imagem base64 (qrCodeBase64), mostrar como <img>
        if (data.qrCodeBase64) {
          const img = document.createElement('img');
          img.src = `data:image/png;base64,${data.qrCodeBase64}`;
          img.alt = 'QR Code PIX';
          img.style.maxWidth = '200px';
          qrContainer.appendChild(img);
        } else if (pixCode && typeof QRCode !== 'undefined') {
          QRCode.toCanvas(pixCode, { width: 200, margin: 2 }, (err, canvas) => {
            if (!err && canvas) {
              qrContainer.appendChild(canvas);
            } else {
              console.error('Erro ao gerar QR Code:', err);
              qrContainer.innerHTML = '<p style="color:#999;padding:20px;">QR Code indispon√≠vel</p>';
            }
          });
        } else {
          qrContainer.innerHTML = '<p style="color:#999;padding:20px;">QR Code indispon√≠vel</p>';
        }
        
        // Iniciar timer
        iniciarTimer(15 * 60); // 15 minutos
        
        // Iniciar verifica√ß√£o de status
        iniciarVerificacaoStatus(data.paymentId, plano, dias);
        
      } catch (err) {
        console.error('‚ùå Erro:', err);
        document.getElementById('pixLoading').style.display = 'none';
        document.getElementById('pixErro').style.display = 'block';
        
        // Mostrar erro detalhado no console
        const erroDiv = document.querySelector('#pixErro .status-msg');
        if (erroDiv) {
          erroDiv.innerHTML = `‚ùå ${err.message || 'Erro ao gerar PIX. Tente novamente.'}`;
        }
      }
    }
    
    // EXPOR FUN√á√ÉO GLOBALMENTE
    window.iniciarPagamento = iniciarPagamento;

    // Timer
    function iniciarTimer(segundos) {
      if (timerInterval) clearInterval(timerInterval);
      
      let tempo = segundos;
      const display = document.getElementById('timerDisplay');
      
      timerInterval = setInterval(() => {
        const minutos = Math.floor(tempo / 60);
        const segs = tempo % 60;
        display.textContent = `${minutos.toString().padStart(2, '0')}:${segs.toString().padStart(2, '0')}`;
        
        if (tempo <= 0) {
          clearInterval(timerInterval);
          document.getElementById('statusMsg').className = 'status-msg erro';
          document.getElementById('statusMsg').innerHTML = '‚è∞ PIX expirado. Gere um novo c√≥digo.';
        }
        
        tempo--;
      }, 1000);
    }

    // Verificar status do pagamento
    function iniciarVerificacaoStatus(paymentId, plano, dias) {
      if (checkInterval) clearInterval(checkInterval);
      
      checkInterval = setInterval(async () => {
        try {
          const headers = {};
          if (currentUser) {
            try {
              headers['Authorization'] = `Bearer ${await currentUser.getIdToken()}`;
            } catch (e) {}
          }
          
          const response = await fetch(`/api/verificar-pix/${paymentId}`, { headers });
          const data = await response.json();
          
          console.log('üìä Status do pagamento:', data.status);
          
          if (data.status === 'approved' || data.status === 'pago') {
            // Pagamento confirmado!
            clearInterval(checkInterval);
            clearInterval(timerInterval);
            
            document.getElementById('statusMsg').className = 'status-msg sucesso';
            document.getElementById('statusMsg').innerHTML = '‚úÖ Pagamento confirmado! Ativando seu plano...';
            
            // Atualizar plano do usu√°rio
            await ativarPlano(plano, dias);
            
            // Redirecionar ap√≥s 2 segundos
            setTimeout(() => {
              window.location.href = '/vods.html';
            }, 2000);
          }
        } catch (err) {
          console.error('Erro ao verificar status:', err);
        }
      }, 5000); // Verificar a cada 5 segundos
    }

    // Ativar plano do usu√°rio
    async function ativarPlano(plano, dias) {
      if (!currentUser) {
        console.log('Usu√°rio n√£o logado, plano ser√° ativado pelo servidor');
        return;
      }
      
      const novaExpiracao = new Date();
      novaExpiracao.setDate(novaExpiracao.getDate() + dias);
      
      const userData = {
        plano,
        data_expiracao: novaExpiracao.toISOString(),
        dataExpiracao: novaExpiracao.toISOString(),
        status: 'ativo',
        suspenso: false,
        ultimoPagamento: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };
      
      // Atualizar no Firebase RTDB
      try {
        await update(ref(rtdb, `usuarios/${currentUser.uid}`), userData);
        console.log('‚úÖ Plano atualizado no Firebase');
      } catch (err) {
        console.error('Erro Firebase:', err);
      }
      
      // Atualizar no Firestore
      try {
        await updateDoc(doc(firestore, 'usuarios', currentUser.uid), userData);
        console.log('‚úÖ Plano atualizado no Firestore');
      } catch (err) {
        // Se n√£o existir, criar
        try {
          await setDoc(doc(firestore, 'usuarios', currentUser.uid), {
            ...userData,
            email: currentUser.email,
            createdAt: new Date().toISOString()
          });
        } catch (e) {
          console.error('Erro Firestore:', e);
        }
      }
    }

    // Copiar c√≥digo PIX
    function copiarPix() {
      const pixCode = document.getElementById('pixCode').textContent;
      navigator.clipboard.writeText(pixCode).then(() => {
        const btn = document.querySelector('.btn-copiar');
        btn.textContent = '‚úÖ Copiado!';
        btn.style.background = 'linear-gradient(135deg, #22c55e, #16a34a)';
        setTimeout(() => {
          btn.textContent = 'üìã Copiar C√≥digo';
          btn.style.background = 'linear-gradient(135deg, #16a34a, #22c55e)';
        }, 2000);
      }).catch(err => {
        console.error('Erro ao copiar:', err);
        alert('Erro ao copiar. Selecione o c√≥digo manualmente.');
      });
    }
    window.copiarPix = copiarPix;

    // Fechar modal
    function fecharModal() {
      document.getElementById('modalPix').classList.remove('active');
      if (timerInterval) clearInterval(timerInterval);
      if (checkInterval) clearInterval(checkInterval);
    }
    window.fecharModal = fecharModal;

    // Fechar modal com ESC
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') fecharModal();
    });
    
    // Log quando o m√≥dulo carregar
    console.log('‚úÖ M√≥dulo de pagamento carregado!');
    // Teste: garantir que o bot√£o est√° clic√°vel
    document.querySelectorAll('.plan-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        console.log('üü¢ Bot√£o de pagamento clicado:', btn);
      });
    });
  </script>
</body>
</html>
